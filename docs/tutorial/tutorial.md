# Туториал по работе с пакетом Calibration Processing

## Содержание
1. [Введение](#введение)
2. [Установка и настройка](#установка-и-настройка)
3. [Подготовка данных](#подготовка-данных)
4. [Запуск программы](#запуск-программы)
5. [Настройка параметров](#настройка-параметров)
6. [Анализ результатов](#анализ-результатов)
7. [Устранение проблем](#устранение-проблем)

---

## Введение

Пакет **Calibration Processing** предназначен для автоматической обработки данных гравиметра Scintrex CG-6 и расчета калибровочных параметров. Программа объединяет относительные измерения гравиметра с абсолютными опорными значениями для определения:

- Коэффициентов калибровки прибора
- Параметров дрейфа
- Статистических характеристик точности

### Что умеет программа:
- ✅ Загружает данные CG-6 в формате `.dat`
- ✅ Обрабатывает файлы абсолютных измерений `.xlsx`
- ✅ Автоматически учитывает временной дрейф
- ✅ Рассчитывает калибровочные коэффициенты методом наименьших квадратов
- ✅ Создает подробные отчеты в Excel
- ✅ Поддерживает GUI и командную строку

---

## Установка и настройка

### Системные требования

- **Python 3.8 или выше**
- **Windows, Linux или macOS**
- **10 МБ свободного места**

### Шаг 1: Проверка Python

Откройте командную строку и выполните:

```bash
python --version
```

*[Место для скриншота: окно командной строки с выводом версии Python]*

Если Python не установлен, скачайте его с [python.org](https://python.org).

### Шаг 2: Установка пакета

В папке с проектом выполните:

```bash
pip install .
```

*[Место для скриншота: процесс установки пакета через pip]*

### Шаг 3: Проверка установки

Убедитесь, что программа установилась корректно:

```bash
python scripts/calibration.py --help
```

*[Место для скриншота: вывод справки программы]*

---

## Подготовка данных

### Структура проекта

Создайте рабочую папку со следующей структурой:

```
ваш_проект/
├── data/
│   ├── relative/              # Файлы CG-6
│   │   ├── CG-6_0527_06072025.dat
│   │   ├── CG-6_0528_06072025.dat
│   │   └── CG-6_0531_06072025.dat
│   └── absolute.xlsx          # Опорные значения
└── results/                   # Результаты (создается автоматически)
```

*[Место для скриншота: структура папок в проводнике]*

### Формат файлов CG-6

Программа работает с стандартными файлами экспорта CG-6 в формате `.dat`. Файл содержит:

1. **Заголовок с метаданными** (начинается с `/`)
   - Серийный номер прибора
   - Параметры калибровки
   - Настройки измерений

2. **Таблицу данных** с колонками:
   - Station - название точки
   - Date/Time - дата и время измерения  
   - CorrGrav - скорректированная гравитация
   - StdErr - стандартная ошибка
   - И другие параметры...

*[Место для скриншота: пример содержимого файла .dat в текстовом редакторе]*

### Формат файла absolute.xlsx

Excel файл должен содержать следующие обязательные колонки:

| Колонка | Описание | Единицы |
|---------|----------|---------|
| Station | Название точки | - |
| gravity_eff | Абсолютная гравитация | мГал |
| h_eff | Высота измерения | м |
| a | Вертикальный градиент (линейный) | мГал/м |
| b | Вертикальный градиент (квадратичный) | мГал/м² |
| ua | Неопределенность параметра a | мГал/м |
| ub | Неопределенность параметра b | мГал/м² |
| covab | Ковариация между a и b | - |

*[Место для скриншота: пример файла absolute.xlsx в Excel]*

### Соответствие станций

⚠️ **Важно**: Названия станций в файлах CG-6 и absolute.xlsx должны точно совпадать!

Примеры правильного соответствия:
- CG-6: `Station = "Point_01"` ↔ Excel: `Station = "Point_01"`
- CG-6: `Station = "BASE"` ↔ Excel: `Station = "BASE"`

*[Место для скриншота: сравнение названий станций в разных файлах]*

---

## Запуск программы

### Способ 1: GUI режим (рекомендуется)

Запустите программу без параметров:

```bash
python scripts/calibration.py
```

Откроется последовательность диалоговых окон:

#### Выбор файлов CG-6

*[Место для скриншота: диалог выбора файлов .dat]*

1. Выберите **все файлы CG-6** для обработки
2. Можете выбрать несколько файлов одновременно (Ctrl+Click)
3. Нажмите **Открыть**

#### Выбор файла абсолютных измерений

*[Место для скриншота: диалог выбора файла .xlsx]*

1. Выберите файл с абсолютными измерениями
2. Убедитесь, что формат соответствует требованиям
3. Нажмите **Открыть**

#### Выбор выходного файла

*[Место для скриншота: диалог сохранения результатов]*

1. Укажите имя файла результатов (например, `results.xlsx`)
2. Выберите папку для сохранения
3. Нажмите **Сохранить**

#### Дополнительные настройки

Программа последовательно покажет диалоги для настройки:

**Логирование**
*[Место для скриншота: диалог включения логирования]*

**Метод расчета**
*[Место для скриншота: диалог выбора метода (WLS/OLS/RLM)]*
- **WLS** - взвешенный МНК (рекомендуется)
- **OLS** - обычный МНК  
- **RLM** - робастный МНК

**Степень полинома дрейфа**
*[Место для скриншота: диалог выбора степени дрейфа]*
- **1** - линейный дрейф
- **2** - квадратичный дрейф (рекомендуется)

**Степень полинома калибровки**
*[Место для скриншота: диалог выбора степени калибровки]*
- **1** - линейная калибровка (рекомендуется)
- **2** - квадратичная калибровка

**Высота прибора**
*[Место для скриншота: диалог ввода высоты прибора]*
- Укажите высоту установки гравиметра над пунктом (по умолчанию 0.21 м)

### Способ 2: Командная строка

Для опытных пользователей доступен запуск через командную строку:

```bash
python scripts/calibration.py \
  --relative data/relative/CG-6_0527_06072025.dat data/relative/CG-6_0528_06072025.dat \
  --absolute data/absolute.xlsx \
  --output results.xlsx \
  --method WLS \
  --drift_degree 2 \
  --calib_degree 1 \
  --meter_height 0.21 \
  --logging
```

*[Место для скриншота: выполнение команды в терминале]*

---

## Настройка параметров

### Параметры обработки

#### Метод расчета (`--method`)

| Метод | Описание | Когда использовать |
|-------|----------|-------------------|
| **WLS** | Взвешенный МНК | Рекомендуется для большинства случаев |
| **OLS** | Обычный МНК | Когда все измерения имеют одинаковую точность |
| **RLM** | Робастный МНК | При наличии выбросов в данных |

#### Степень дрейфа (`--drift_degree`)

- **1** - линейный дрейф: `g(t) = a₀ + a₁·t`
- **2** - квадратичный дрейф: `g(t) = a₀ + a₁·t + a₂·t²` (рекомендуется)

*[Место для скриншота: график примера линейного и квадратичного дрейфа]*

#### Степень калибровки (`--calib_degree`)

- **1** - линейная: `g_истинная = a·g_измеренная + b`
- **2** - квадратичная: `g_истинная = a·g_измеренная² + b·g_измеренная + c`

#### Высота прибора (`--meter_height`)

Программа автоматически пересчитывает абсолютные значения на высоту установки гравиметра, используя вертикальный градиент из файла absolute.xlsx.

*[Место для скриншота: схема установки гравиметра с указанием высоты]*

---

## Анализ результатов

### Структура выходного файла

Программа создает Excel файл с двумя листами:

#### Лист 1: calibration_parameters

*[Место для скриншота: лист с параметрами калибровки в Excel]*

**Основные колонки:**
- `meter` - серийный номер прибора
- `calib_deg_1` - коэффициент линейной калибровки
- `calib_deg_1_ste` - стандартная ошибка коэффициента
- `diff_count` - количество точек калибровки
- `diff_mean` - среднее отклонение (мГал)
- `diff_ste` - стандартное отклонение (мГал)
- `diff_min/max` - минимальные/максимальные отклонения

#### Лист 2: fitted_ties

*[Место для скриншота: лист с результатами привязки в Excel]*

**Основные колонки:**
- `tie` - измеренные разности (после коррекции дрейфа)
- `tie_ste` - стандартные ошибки измерений
- `ref` - опорные разности из абсолютных измерений
- `ref_ste` - стандартные ошибки опорных значений
- `fit_tie` - значения, рассчитанные по калибровке
- `diff` - остаточные отклонения после калибровки

### Интерпретация результатов

#### Оценка качества калибровки

**Хорошие показатели:**
- `diff_ste` < 0.01 мГал (стандартное отклонение)
- `diff_mean` ≈ 0 мГал (систематические ошибки отсутствуют)
- Количество точек `diff_count` ≥ 3

*[Место для скриншота: пример хороших результатов калибровки]*

**Проблемные показатели:**
- `diff_ste` > 0.05 мГал (низкая точность)
- |`diff_mean`| > 0.02 мГал (систематические ошибки)
- Большой разброс в `diff_min/max`

*[Место для скриншота: пример проблемных результатов с выделением проблемных значений]*

#### Анализ коэффициентов

**Коэффициент калибровки (`calib_deg_1`):**
- Близкий к 1.0 означает хорошую заводскую калибровку
- Отклонение >1% требует внимания
- Стандартная ошибка должна быть <0.1% от значения

*[Место для скриншота: график зависимости истинных значений от измеренных с линией калибровки]*

### Создание отчета

На основе результатов создайте итоговый отчет:

```markdown
## Отчет о калибровке гравиметра CG-6 №527

**Дата:** 06.07.2025
**Оператор:** DAULET
**Количество точек:** 5
**Метод обработки:** WLS, квадратичный дрейф

### Результаты калибровки
- Коэффициент калибровки: 1.0023 ± 0.0005
- Среднеквадратичное отклонение: 0.008 мГал  
- Максимальное отклонение: 0.015 мГал

### Заключение
Калибровка выполнена успешно. Прибор показывает стабильные результаты 
с точностью в пределах технических требований.
```

*[Место для скриншота: пример оформленного отчета]*

---

## Устранение проблем

### Типичные ошибки и решения

#### Ошибка: "CG-6 data file not found"

**Причина:** Неверный путь к файлу или файл поврежден

**Решение:**
1. Проверьте правильность пути к файлу
2. Убедитесь, что файл существует и доступен для чтения
3. Проверьте права доступа к файлу

*[Место для скриншота: сообщение об ошибке и правильный путь к файлу]*

#### Ошибка: "Reference file not found"

**Причина:** Отсутствует или недоступен файл absolute.xlsx

**Решение:**
1. Проверьте наличие файла absolute.xlsx
2. Убедитесь в правильности формата файла
3. Проверьте наличие всех обязательных колонок

*[Место для скриншота: пример правильного файла absolute.xlsx]*

#### Ошибка: Несоответствие станций

**Причина:** Названия станций в CG-6 и absolute.xlsx не совпадают

**Решение:**
1. Откройте оба файла и сравните названия станций
2. Исправьте названия для точного соответствия
3. Учитывайте регистр символов

*[Место для скриншота: сравнение названий станций в разных файлах с выделением несоответствий]*

#### Предупреждение: Высокое стандартное отклонение

**Причина:** Низкое качество данных или проблемы с измерениями

**Возможные решения:**
1. Проверьте исходные данные CG-6 на наличие выбросов
2. Попробуйте метод RLM для устойчивости к выбросам
3. Исключите проблемные точки из обработки
4. Проверьте правильность абсолютных значений

*[Место для скриншота: график остатков с выбросами]*

#### Проблема: Программа зависает в GUI режиме

**Решение:**
1. Используйте командную строку вместо GUI
2. Проверьте размер файлов данных
3. Закройте другие программы для освобождения памяти

#### Проблема: Некорректные результаты

**Диагностика:**
1. Проверьте единицы измерения в absolute.xlsx (должны быть мГал)
2. Убедитесь в правильности вертикального градиента
3. Проверьте высоту прибора meter_height
4. Сравните результаты с ручными расчетами на нескольких точках

*[Место для скриншота: таблица для проверки расчетов вручную]*

### Диагностические команды

Для диагностики проблем используйте:

```bash
# Включить подробное логирование
python scripts/calibration.py --logging ...

# Проверить справку по параметрам  
python scripts/calibration.py --help

# Тестовый запуск с минимальными данными
python scripts/calibration.py --relative test.dat --absolute test.xlsx
```

*[Место для скриншота: вывод логирования программы]*

### Контакты для поддержки

При возникновении проблем обращайтесь:

**Автор:** Roman Sermiagin  
**Email:** roman.sermiagin@gmail.com  
**Версия программы:** 0.0.1

---

## Заключение

Пакет Calibration Processing обеспечивает автоматизированную обработку данных гравиметра CG-6 с высокой точностью и надежностью. При правильной подготовке данных и настройке параметров программа позволяет получить калибровочные коэффициенты, соответствующие современным требованиям гравиметрии.

**Ключевые преимущества:**
- ✅ Автоматическая коррекция временного дрейфа
- ✅ Статистически обоснованные методы обработки
- ✅ Подробная оценка точности результатов
- ✅ Удобные форматы вывода для дальнейшего анализа
- ✅ Поддержка различных сценариев использования

Следуя данному туториалу, вы сможете эффективно использовать программу для решения задач калибровки гравиметров в производственных и научных целях.

---

*© 2025 Roman Sermiagin. Данный туториал является частью документации к пакету Calibration Processing.*